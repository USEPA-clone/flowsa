# This is the general method reference file for method 2 (Summary)
# Year-specific GHG_national_m2 files import this file to define attribution rules
# that are further customized
# m2 for the GHG national utilizes a summary level sector attribution


!include:USEEIO_summary_target.yaml
year: &ghg_year 2016
target_naics_year: 2012
geoscale: national

_mecs_year: &mecs_year 2018

_attribution_sources:
  BEA: &bea_summary
    year: *ghg_year
    activity_to_sector_mapping: BEA_2012_Summary
    # selection_fields:
    #   ActivityProducedBy: {'324': ''}  # Petroleum 324110
    exclusion_fields: # Avoid unnecessary warnings about not being mapped to sectors
      ActivityConsumedBy: ['F030', 'F040', 'F050', 'F051', 
                           'F02E', 'F06E', 'F07E', 'F10E',
                           'Total Commodity Output',
                           'Total Final Uses (GDP)',
                           'Total Intermediate']
      ActivityProducedBy: ['Total Commodity Output']
    attribution_method: equal
    ## No attribution supplied (will use equal) because target level for
    ## modeling is BEA summary level.

  BEA_detail: &bea_detail
    year: 2012
    activity_to_sector_mapping: BEA_2012_Detail
    # selection_fields:
    #   ActivityProducedBy: {'324': ''}  # Petroleum 324110
    exclusion_fields: # Avoid unnecessary warnings about not being mapped to sectors
      ActivityConsumedBy: ['F03000', 'F04000', 'F05000', 'F02E00',
                           'F06E00', 'F07E00', 'F10E00',
                           'T001', 'T004', 'T007']
      ActivityProducedBy: ['T007']
    attribution_method: equal


  EIA_MECS_Energy: &mecs_energy
    year: *mecs_year
    selection_fields: &mecs_energy_default_selection
      Class: Energy # or Other (for non-energy use)
      Unit: Trillion Btu
      # FlowName: Coal # override this
      Location: '00000'
      Description:
        - Table 2.2 # applies to Class Other
        - Table 3.2 # applies to Class Energy
    exclusion_fields:
      ActivityConsumedBy: '31-33'
    estimate_suppressed: !script_function:EIA_MECS estimate_suppressed_mecs_energy
    # attribution_method: proportional
    # attribution_source: # Include in main method
    #   BEA_Summary_Use_PRO_BeforeRedef:
    #     <<: *bea_summary
    #     selection_fields:
    #       ActivityProducedBy: {'XXXXX': ''}


source_names:
  EPA_GHGI_T_2_1: #U.S. GHG emissions
    # year: # override this
    fedefl_mapping: GHGI
    activity_sets:
      direct:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_2_1:activity_sets:direct

      electricity_transmission:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_2_1:activity_sets:electricity_transmission

      electric_power:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_2_1:activity_sets:electric_power

      liming:
        selection_fields:
          PrimaryActivity: Liming #CO2
        attribution_method: equal

      urea:
        selection_fields:
          PrimaryActivity:
            - Urea Consumption for Non-Agricultural Purposes #CO2
        attribution_method: proportional
        attribution_source:
          BEA_Detail_Use_PRO_BeforeRedef:
            <<: *bea_detail
            selection_fields:
              ActivityProducedBy: {'325310': ''} # Chemicals (325310)

      urea_fertilizer:
        selection_fields:
          PrimaryActivity: Urea Fertilization #CO2
        attribution_method: equal

      carbonate_use:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_2_1:activity_sets:carbonate_use

      lead:
        selection_fields:
          PrimaryActivity: Lead Production #CO2
        attribution_method: direct

      nitrous_oxide_use:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_2_1:activity_sets:nitrous_oxide_use


## Fossil Fuels
  EPA_GHGI_T_3_68: &natgas #CH4 from Natural Gas Systems
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_68
    # year: # override this
  EPA_GHGI_T_3_70: *natgas #CO2 from Natural Gas Systems mimics CH4
  EPA_GHGI_T_3_72: *natgas #N2O from Natural Gas Systems, not used in original method, mimics CH4

  EPA_GHGI_T_3_42: &petroleum #CH4 from Petroleum Systems
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_42
    # year: # override this
  EPA_GHGI_T_3_44: *petroleum #CO2 from Petroleum Systems mimics CH4
  EPA_GHGI_T_3_46: *petroleum #N2O from Petroleum Systems, not in prior method, mimics CH4

## Agriculture
  EPA_GHGI_T_5_28: #CH4, N2O, CO and NOx from field burning of residues
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_5_28
    # year: # override this
  EPA_GHGI_T_5_3:  &animals #CH4 from Enteric Fermentation
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_5_3
    # year: # override this
  EPA_GHGI_T_5_6: *animals #CH4 and N2O from manure, mimics enteric fermentation

  EPA_GHGI_T_5_17: #Direct N2O emissions from agricultural soils
    # year: # override this
    fedefl_mapping: GHGI
    activity_sets:
      fertilizer_use:
        selection_fields:
          PrimaryActivity:
            - Organic Amendment Cropland
            - Residue N Cropland
            - Synthetic Fertilizer Cropland
        attribution_method: direct

      cropland:
        selection_fields:
          PrimaryActivity:
            - Mineralization and Asymbiotic Fixation Cropland
            - Drained Organic Soils Cropland
        attribution_method: direct

      pasture: &pasture
        selection_fields:
          PrimaryActivity:
            - All activities Grassland
        attribution_method: equal


  EPA_GHGI_T_5_18: #Indirect N2O emissions from agricultural soils
    # year: # override this
    fedefl_mapping: GHGI
    activity_sets:
      fertilizer_use:
        selection_fields:
          PrimaryActivity:
            - Volatilization & Atm. Deposition Cropland
            - Surface Leaching & Run-Off Cropland
        attribution_method: direct
      pasture:
        selection_fields:
          PrimaryActivity:
            - All activities Grassland
        attribution_method: equal


## Mobile Sources
  EPA_GHGI_T_3_13: #CO2 from mobile combustion
    fedefl_mapping: GHGI
    activity_sets:
      direct_petroleum:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_13:activity_sets:direct_petroleum

      direct_ng:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_13:activity_sets:direct_ng
        selection_fields:
          PrimaryActivity:
            Buses Natural Gas: Buses
            Pipeline Natural Gas: Pipeline Natural Gas

      petroleum_fuels:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_13:activity_sets:petroleum_fuels
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # purchases of refinery products (324110)


  EPA_GHGI_T_3_14: &mobile #CH4 from mobile combustion
    fedefl_mapping: GHGI
    activity_sets:
      direct_gasoline:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:direct_gasoline

      direct_non_road:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:direct_non_road

      petroleum_fuels_diesel:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:petroleum_fuels_diesel
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # purchases of refinery products (324110)

      petroleum_fuels_gasoline:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:petroleum_fuels_gasoline
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # purchases of refinery products (324110)

      construction_and_mining: #this set is allocated by purchases of construction equipment
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:construction_and_mining
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'333': ''} # purchases of construction/mining equipment (333120)

      farm_non_road: #this set is allocated by purchases of farm machinery
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:farm_non_road
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'333': ''} # purchases of farm machinery (333111)

      other_non_road: #this set is allocated by purchases of petroleum refining
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:other_non_road
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # purchases of refinery products (324110)

      alt_fuel_on_road: #this set is allocated by purchases of natural gas
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_14:activity_sets:alt_fuel_on_road
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'22': ''} # purchases of natural gas (221200)

  EPA_GHGI_T_3_15: *mobile #N2O from mobile combustion duplicates method for CH4


## Stationary Combustion
  GHGI_CO2_stationary_combustion: # CO2 emissions from stationary combustion
    fedefl_mapping: GHGI
    # year: # override this
    clean_fba_before_activity_sets: !script_function:EPA_GHGI allocate_industrial_combustion
    clean_parameter: # Override each year for use in allocate_industrial_combustion
        energy_fba: 'EIA_MECS_Energy'
        year: *mecs_year
        ghg_fba: 'EPA_GHGI_T_A_7' # 2018 Table
    activity_sets:
      direct_attribution: #direct allocation
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:direct_attribution

      non_manufacturing_coal:
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:non_manufacturing_coal

      non_manufacturing_natural_gas: # Applies to non-manufacturing sectors like ag and mining
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:non_manufacturing_natural_gas
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'22': ''} # purchases of natural gas (221200)

      coal_manufacturing_co2: # Industrial Coal for Manufacturing
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:coal_manufacturing_co2
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              <<: *mecs_energy_default_selection
              FlowName:
                - Coal
                - Coke and Breeze
            # attribution_source: TODO do we need attribution of MECS data?
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'212100': ''} # purchases of coal

      natural_gas_manufacturing: # Industrial Natural Gas for manufacturing
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:natural_gas_manufacturing
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              <<: *mecs_energy_default_selection
              FlowName: Natural Gas
            # attribution_source:
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'221200': ''} # purchases of natural gas

      petroleum: # Petroleum
        !include:GHG_national_m1_common.yaml:source_names:GHGI_CO2_stationary_combustion:activity_sets:petroleum
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # purchases of refinery products (324110)


  EPA_GHGI_T_3_8:  &stationary_combustion # CH4 emissions from stationary combustion
    # year: #override this with ghgi_year
    clean_fba_before_activity_sets: !script_function:EPA_GHGI allocate_industrial_combustion
    clean_parameter: # Override each year for use in allocate_industrial_combustion
        energy_fba: 'EIA_MECS_Energy'
        year: *mecs_year
        ghg_fba: 'EPA_GHGI_T_A_7' # 2018 Table
    fedefl_mapping: GHGI
    activity_sets:
      residential:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:residential

      electric_power:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:electric_power

      fuel_oil:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:fuel_oil
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''}  # purchases of refinery products (324110)

      natural_gas_nonmanufacturing:  # Commercial Natural gas
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:natural_gas_nonmanufacturing
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'22': ''}  # purchases of natural gas (221200)

      coal_nonmanufacturing:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:coal_nonmanufacturing

      coal_manufacturing:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:coal_manufacturing
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              <<: *mecs_energy_default_selection
              FlowName: Coal
            # attribution_source:
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'212100': ''} # purchases of coal

      ng_manufacturing:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_3_8:activity_sets:ng_manufacturing
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              <<: *mecs_energy_default_selection
              FlowName: Natural Gas
            # attribution_source:
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'221200': ''} # purchases of natural gas

    #Intentionally left out 'Wood Commercial' and 'Wood Industrial'

  EPA_GHGI_T_3_9:
    <<: *stationary_combustion # N2O emissions from stationary combustion

## Other sources
  EPA_GHGI_T_4_46: #CO2 for selected petrochemicals
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_46
    # year: # override with ghgi_year

  GHGI_nonenergy_fossil_fuel_emissions: # Fossil fuel for non-energy uses
    # year: #override with ghgi_year
    fedefl_mapping: GHGI
    activity_sets:
      coal:
        !include:GHG_national_m1_common.yaml:source_names:GHGI_nonenergy_fossil_fuel_emissions:activity_sets:coal

      petroleum_neu: # consumed petroleum products
        !include:GHG_national_m1_common.yaml:source_names:GHGI_nonenergy_fossil_fuel_emissions:activity_sets:petroleum
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              Class: Other
              Unit: Trillion Btu
              FlowName: 
                - Residual Fuel Oil
                - Distillate Fuel Oil
                - Hydrocarbon Gas Liquids, excluding natural gasoline
            # attribution_source:
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'324110': ''} # purchases of refineries

      natural_gas_neu: # consumed nat gas to chemical plants
        !include:GHG_national_m1_common.yaml:source_names:GHGI_nonenergy_fossil_fuel_emissions:activity_sets:natural_gas
        attribution_source:
          EIA_MECS_Energy:
            <<: *mecs_energy
            selection_fields:
              Class: Other
              FlowName: Natural Gas
              Unit: Trillion Btu
            # attribution_source:
            #   BEA_Summary_Use_PRO_BeforeRedef:
            #     <<: *bea_summary
            #     selection_fields:
            #       ActivityProducedBy: {'221200': ''} # purchases of natural gas

      transportation_lubricants:
        !include:GHG_national_m1_common.yaml:source_names:GHGI_nonenergy_fossil_fuel_emissions:activity_sets:transportation_lubricants
        attribution_source:
          BEA_Summary_Use_PRO_BeforeRedef:
            <<: *bea_summary
            selection_fields:
              ActivityProducedBy: {'324': ''} # use of petroleum products (324110)

## Other Emissions
  EPA_GHGI_T_4_50: # HFCs from HCFC-22 production
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_50
    # year: # override with ghgi_year

  EPA_GHGI_T_4_96: # HFCs and other emissions from electronics manufacture
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_96
    # year: # override with ghgi_year

  EPA_GHGI_T_4_102: # HFCs and PFCs from ODS Substitutes
    clean_fba_before_activity_sets: !script_function:EPA_GHGI split_HFCs_by_type
    clean_parameter:
        # Proportions of specific HFCs are assigned based on national total
        flow_fba: EPA_GHGI_T_4_100
    # year: # override with ghgi_year
    fedefl_mapping: GHGI
    activity_sets:
      households:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_102:activity_sets:households

      refrigerants:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_102:activity_sets:refrigerants

      air_conditioning:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_102:activity_sets:air_conditioning

      foams:
        !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_102:activity_sets:foams


  EPA_GHGI_T_A_97: # HFCs from Transportation
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_A_97
    # year: # override with ghgi_year


  EPA_GHGI_T_4_80: # PFCs from aluminum production
    !include:GHG_national_m1_common.yaml:source_names:EPA_GHGI_T_4_80
    # year: # override with ghgi_year


  EPA_GHGI_T_4_86: # HFCs, SF6, CO2 from magnesium production
    # year: # override with ghgi_year
    fedefl_mapping: GHGI
    selection_fields:
      PrimaryActivity: Magnesium Production and Processing
    attribution_method: direct
